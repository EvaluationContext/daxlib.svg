(function(){
var hljsGrammar = (function () {
  /*
  Language: DAX
  Description: Data Analysis Expressions (DAX) is a library of functions and operators that can be combined to build formulas and expressions in Power BI, Analysis Services, and Power Pivot in Excel data models.
  Author: Jake Duddy <evaluationcontext@gmail.com@gmail.com>
  Website: https://learn.microsoft.com/en-us/dax/
  Category: query
  */
  /** @type LanguageFn */
  function dax(hljs) {
    // https://learn.microsoft.com/en-us/dax/statements-dax
    const KEYWORDS = [
      'AXIS',
      'ROWS',
      'COLUMN',
      'DEFINE',
      'DENSIFY',
      'EVALUATE',
      'GROUP',
      'MEASURE',
      'MPARAMETER',
      'ORDER',
      'BY',
      'RETURN',
      'START',
      'AT',
      'TABLE',
      'TOTAL',
      'VAR',
      'WITH',
      'VISUAL',
      'SHAPE',
      'IN',
      // 'TRUE', // Removed to prevent highlighting in SWITCH statements
      // 'FALSE', // Removed to prevent highlighting in SWITCH statements
      'NOT',
      'ASC',
      'DESC',
      'SKIP',
      'DENSE',
      'BLANKS',
      'FIRST',
      'LAST',
      'WEEK',
      'BOTH',
      'NONE',
      'ONEWAY',
      'ONEWAY_RIGHTFILTERSLEFT',
      'ONEWAY_LEFTFILTERSRIGHT',
      'KEEP',
      'REL',
    ];

    // https://learn.microsoft.com/en-us/dax/dax-function-reference
    const FUNCTIONS = [
      'ABS',
      'ACCRINT',
      'ACCRINTM',
      'ACOS',
      'ACOSH',
      'ACOT',
      'ACOTH',
      'ADDCOLUMNS',
      'ADDMISSINGITEMS',
      'ALL',
      'ALLCROSSFILTERED',
      'ALLEXCEPT',
      'ALLNOBLANKROW',
      'ALLSELECTED',
      'AMORDEGRC',
      'AMORLINC',
      'AND',
      'APPROXIMATEDISTINCTCOUNT',
      'ASIN',
      'ASINH',
      'ATAN',
      'ATANH',
      'AVERAGE',
      'AVERAGEA',
      'AVERAGEX',
      'BETA.DIST',
      'BETA.INV',
      'BITAND',
      'BITLSHIFT',
      'BITOR',
      'BITRSHIFT',
      'BITXOR',
      'BLANK',
      'CALCULATE',
      'CALCULATETABLE',
      'CALENDAR',
      'CALENDARAUTO',
      'CEILING',
      'CHISQ.DIST',
      'CHISQ.DIST.RT',
      'CHISQ.INV',
      'CHISQ.INV.RT',
      'CLOSINGBALANCEMONTH',
      'CLOSINGBALANCEQUARTER',
      'CLOSINGBALANCEYEAR',
      'COALESCE',
      'COLLAPSE',
      'COLLAPSEALL',
      'COLUMNSTATISTICS',
      'COMBIN',
      'COMBINA',
      'COMBINEVALUES',
      'CONCATENATE',
      'CONCATENATEX',
      'CONFIDENCE.NORM',
      'CONFIDENCE.T',
      'CONTAINS',
      'CONTAINSROW',
      'CONTAINSSTRING',
      'CONTAINSSTRINGEXACT',
      'CONVERT',
      'COS',
      'COSH',
      'COT',
      'COTH',
      'COUNT',
      'COUNTA',
      'COUNTAX',
      'COUNTBLANK',
      'COUNTROWS',
      'COUNTX',
      'COUPDAYBS',
      'COUPDAYS',
      'COUPDAYSNC',
      'COUPNCD',
      'COUPNUM',
      'COUPPCD',
      'CROSSFILTER',
      'CROSSJOIN',
      'CUMIPMT',
      'CUMPRINC',
      'CURRENCY',
      'CURRENTGROUP',
      'CUSTOMDATA',
      'DATATABLE',
      'DATE',
      'DATEADD',
      'DATEDIFF',
      'DATESBETWEEN',
      'DATESINPERIOD',
      'DATESMTD',
      'DATESQTD',
      'DATESYTD',
      'DATEVALUE',
      'DAY',
      'DB',
      'DDB',
      'DEGREES',
      'DETAILROWS',
      'DISC',
      'DISTINCT',
      'DISTINCTCOUNT',
      'DISTINCTCOUNTNOBLANK',
      'DIVIDE',
      'DOLLARDE',
      'DOLLARFR',
      'DURATION',
      'EARLIER',
      'EARLIEST',
      'EDATE',
      'EFFECT',
      'ENDOFMONTH',
      'ENDOFQUARTER',
      'ENDOFYEAR',
      'EOMONTH',
      'ERROR',
      'EVALUATEANDLOG',
      'EVEN',
      'EXACT',
      'EXCEPT',
      'EXP',
      'EXPAND',
      'EXPANDALL',
      'EXPON.DIST',
      'EXTERNALMEASURE',
      'FACT',
      'FALSE',
      'FILTER',
      'FILTERS',
      'FIND',
      'FIRST',
      'FIRSTDATE',
      'FIRSTNONBLANK',
      'FIRSTNONBLANKVALUE',
      'FIXED',
      'FLOOR',
      'FORMAT',
      'FV',
      'GCD',
      'GENERATE',
      'GENERATEALL',
      'GENERATESERIES',
      'GEOMEAN',
      'GEOMEANX',
      'GROUPBY',
      'HASH',
      'HASONEFILTER',
      'HASONEVALUE',
      'HOUR',
      'IF',
      'IF.EAGER',
      'IFERROR',
      'IGNORE',
      'INDEX',
      'INFO.ALTERNATEOFDEFINITIONS',
      'INFO.ANNOTATIONS',
      'INFO.ATTRIBUTEHIERARCHIES',
      'INFO.ATTRIBUTEHIERARCHYSTORAGES',
      'INFO.CALCULATIONGROUPS',
      'INFO.CALCULATIONITEMS',
      'INFO.CHANGEDPROPERTIES',
      'INFO.COLUMNPARTITIONSTORAGES',
      'INFO.COLUMNPERMISSIONS',
      'INFO.COLUMNS',
      'INFO.COLUMNSTORAGES',
      'INFO.CULTURES',
      'INFO.DATACOVERAGEDEFINITIONS',
      'INFO.DATASOURCES',
      'INFO.DELTATABLEMETADATASTORAGES',
      'INFO.DETAILROWSDEFINITIONS',
      'INFO.DICTIONARYSTORAGES',
      'INFO.EXCLUDEDARTIFACTS',
      'INFO.EXPRESSIONS',
      'INFO.EXTENDEDPROPERTIES',
      'INFO.FORMATSTRINGDEFINITIONS',
      'INFO.FUNCTIONS',
      'INFO.GENERALSEGMENTMAPSEGMENTMETADATASTORAGES',
      'INFO.GROUPBYCOLUMNS',
      'INFO.HIERARCHIES',
      'INFO.HIERARCHYSTORAGES',
      'INFO.KPIS',
      'INFO.LEVELS',
      'INFO.LINGUISTICMETADATA',
      'INFO.MEASURES',
      'INFO.MODEL',
      'INFO.OBJECTTRANSLATIONS',
      'INFO.PARQUETFILESTORAGES',
      'INFO.PARTITIONS',
      'INFO.PARTITIONSTORAGES',
      'INFO.PERSPECTIVECOLUMNS',
      'INFO.PERSPECTIVEHIERARCHIES',
      'INFO.PERSPECTIVEMEASURES',
      'INFO.PERSPECTIVES',
      'INFO.PERSPECTIVETABLES',
      'INFO.QUERYGROUPS',
      'INFO.REFRESHPOLICIES',
      'INFO.RELATEDCOLUMNDETAILS',
      'INFO.RELATIONSHIPINDEXSTORAGES',
      'INFO.RELATIONSHIPS',
      'INFO.RELATIONSHIPSTORAGES',
      'INFO.ROLEMEMBERSHIPS',
      'INFO.ROLES',
      'INFO.SEGMENTMAPSTORAGES',
      'INFO.SEGMENTSTORAGES',
      'INFO.STORAGEFILES',
      'INFO.STORAGEFOLDERS',
      'INFO.STORAGETABLECOLUMNS',
      'INFO.STORAGETABLECOLUMNSEGMENTS',
      'INFO.STORAGETABLES',
      'INFO.TABLEPERMISSIONS',
      'INFO.TABLES',
      'INFO.TABLESTORAGES',
      'INFO.VARIATIONS',
      'INT',
      'INTERSECT',
      'INTRATE',
      'IPMT',
      'ISAFTER',
      'ISATLEVEL',
      'ISBLANK',
      'ISCROSSFILTERED',
      'ISEMPTY',
      'ISERROR',
      'ISEVEN',
      'ISFILTERED',
      'ISINSCOPE',
      'ISLOGICAL',
      'ISNONTEXT',
      'ISNUMBER',
      'ISO.CEILING',
      'ISODD',
      'ISONORAFTER',
      'ISPMT',
      'ISSELECTEDMEASURE',
      'ISSUBTOTAL',
      'ISTEXT',
      'KEEPFILTERS',
      'KEYWORDMATCH',
      'LAST',
      'LASTDATE',
      'LASTNONBLANK',
      'LASTNONBLANKVALUE',
      'LCM',
      'LEFT',
      'LEN',
      'LINEST',
      'LINESTX',
      'LN',
      'LOG',
      'LOG10',
      'LOOKUP',
      'LOOKUPVALUE',
      'LOWER',
      'MATCHBY',
      'MAX',
      'MAXA',
      'MAXX',
      'MDURATION',
      'MEDIAN',
      'MEDIANX',
      'MID',
      'MIN',
      'MINA',
      'MINUTE',
      'MINX',
      'MOD',
      'MONTH',
      'MOVINGAVERAGE',
      'MROUND',
      'NAMEOF',
      'NATURALINNERJOIN',
      'NATURALLEFTOUTERJOIN',
      'NETWORKDAYS',
      'NEXT',
      'NEXTDAY',
      'NEXTMONTH',
      'NEXTQUARTER',
      'NEXTYEAR',
      'NOMINAL',
      'NONVISUAL',
      'NORM.DIST',
      'NORM.INV',
      'NORM.S.DIST',
      'NORM.S.INV',
      'NOT',
      'NOW',
      'NPER',
      'ODD',
      'ODDFPRICE',
      'ODDFYIELD',
      'ODDLPRICE',
      'ODDLYIELD',
      'OFFSET',
      'OPENINGBALANCEMONTH',
      'OPENINGBALANCEQUARTER',
      'OPENINGBALANCEYEAR',
      'OR',
      'ORDERBY',
      'PARALLELPERIOD',
      'PARTITIONBY',
      'PATH',
      'PATHCONTAINS',
      'PATHITEM',
      'PATHITEMREVERSE',
      'PATHLENGTH',
      'PDURATION',
      'PERCENTILE.EXC',
      'PERCENTILE.INC',
      'PERCENTILEX.EXC',
      'PERCENTILEX.INC',
      'PERMUT',
      'PI',
      'PMT',
      'POISSON.DIST',
      'POWER',
      'PPMT',
      'PREVIOUS',
      'PREVIOUSDAY',
      'PREVIOUSMONTH',
      'PREVIOUSQUARTER',
      'PREVIOUSYEAR',
      'PRICE',
      'PRICEDISC',
      'PRICEMAT',
      'PRODUCT',
      'PRODUCTX',
      'PV',
      'QUARTER',
      'QUOTIENT',
      'RADIANS',
      'RAND',
      'RANDBETWEEN',
      'RANGE',
      'RANK',
      'RANK.EQ',
      'RANKX',
      'RATE',
      'RECEIVED',
      'RELATED',
      'RELATEDTABLE',
      'REMOVEFILTERS',
      'REPLACE',
      'REPT',
      'RIGHT',
      'ROLLUP',
      'ROLLUPADDISSUBTOTAL',
      'ROLLUPGROUP',
      'ROLLUPISSUBTOTAL',
      'ROUND',
      'ROUNDDOWN',
      'ROUNDUP',
      'ROW',
      'ROWNUMBER',
      'RRI',
      'RUNNINGSUM',
      'SAMEPERIODLASTYEAR',
      'SAMPLE',
      'SAMPLEAXISWITHLOCALMINMAX',
      'SAMPLECARTESIANPOINTSBYCOVER',
      'SEARCH',
      'SECOND',
      'SELECTCOLUMNS',
      'SELECTEDMEASURE',
      'SELECTEDMEASUREFORMATSTRING',
      'SELECTEDMEASURENAME',
      'SELECTEDVALUE',
      'SIGN',
      'SIN',
      'SINH',
      'SLN',
      'SQRT',
      'SQRTPI',
      'STARTOFMONTH',
      'STARTOFQUARTER',
      'STARTOFYEAR',
      'STDEV.P',
      'STDEV.S',
      'STDEVX.P',
      'STDEVX.S',
      'SUBSTITUTE',
      'SUBSTITUTEWITHINDEX',
      'SUM',
      'SUMMARIZE',
      'SUMMARIZECOLUMNS',
      'SUMX',
      'SWITCH',
      'SYD',
      'T.DIST',
      'T.DIST.2T',
      'T.DIST.RT',
      'T.INV',
      'T.INV.2T',
      'TAN',
      'TANH',
      'TBILLEQ',
      'TBILLPRICE',
      'TBILLYIELD',
      'TIME',
      'TIMEVALUE',
      'TOCSV',
      'TODAY',
      'TOJSON',
      'TOPN',
      'TOPNPERLEVEL',
      'TOPNSKIP',
      'TOTALMTD',
      'TOTALQTD',
      'TOTALYTD',
      'TREATAS',
      'TRIM',
      'TRUE',
      'TRUNC',
      'UNICHAR',
      'UNICODE',
      'UNION',
      'UPPER',
      'USERCULTURE',
      'USERELATIONSHIP',
      'USERNAME',
      'USEROBJECTID',
      'USERPRINCIPALNAME',
      'UTCNOW',
      'UTCTODAY',
      'VALUE',
      'VALUES',
      'VAR.P',
      'VAR.S',
      'VARX.P',
      'VARX.S',
      'VDB',
      'WEEKDAY',
      'WEEKNUM',
      'WINDOW',
      'XIRR',
      'XNPV',
      'YEAR',
      'YEARFRAC',
      'YIELD',
      'YIELDDISC',
      'YIELDMAT',
    ];

    // https://dax.guide/datatypes/
    const TYPES = [
      // Data types from the provided table only
      'ANYVAL',
      'SCALAR',
      'INT64',
      'DECIMAL',
      'DOUBLE',
      'STRING',
      'DATETIME',
      'BOOLEAN',
      'NUMERIC',
      'TABLE',
      'ANYREF',
      'INTEGER',
      'BINARY',
      'CURRENCY'
    ];

    // Updated user-defined function matcher
    const USER_DEFINED_FUNCTION = {
      className: 'title.function',
      // Match patterns like EvaluationContext.Colour.Int.ToHex
      begin: /\b[A-Za-z_][A-Za-z0-9_]*(?:\.[A-Za-z_][A-Za-z0-9_]*)+/,
      end: /(?=\s*\()/,
      relevance: 10, // Higher relevance to prioritize this rule
      excludeEnd: true
    };

    // Built-in DAX functions (single word functions followed by parentheses)
    const BUILTIN_FUNCTION = {
      className: 'built_in',
      begin: /\b(?:ABS|ACCRINT|ACCRINTM|ACOS|ACOSH|ACOT|ACOTH|ADDCOLUMNS|ADDMISSINGITEMS|ALL|ALLCROSSFILTERED|ALLEXCEPT|ALLNOBLANKROW|ALLSELECTED|AMORDEGRC|AMORLINC|AND|APPROXIMATEDISTINCTCOUNT|ASIN|ASINH|ATAN|ATANH|AVERAGE|AVERAGEA|AVERAGEX|BETA\.DIST|BETA\.INV|BITAND|BITLSHIFT|BITOR|BITRSHIFT|BITXOR|BLANK|CALCULATE|CALCULATETABLE|CALENDAR|CALENDARAUTO|CEILING|CHISQ\.DIST|CHISQ\.DIST\.RT|CHISQ\.INV|CHISQ\.INV\.RT|CLOSINGBALANCEMONTH|CLOSINGBALANCEQUARTER|CLOSINGBALANCEYEAR|COALESCE|COLLAPSE|COLLAPSEALL|COLUMNSTATISTICS|COMBIN|COMBINA|COMBINEVALUES|CONCATENATE|CONCATENATEX|CONFIDENCE\.NORM|CONFIDENCE\.T|CONTAINS|CONTAINSROW|CONTAINSSTRING|CONTAINSSTRINGEXACT|CONVERT|COS|COSH|COT|COTH|COUNT|COUNTA|COUNTAX|COUNTBLANK|COUNTROWS|COUNTX|COUPDAYBS|COUPDAYS|COUPDAYSNC|COUPNCD|COUPNUM|COUPPCD|CROSSFILTER|CROSSJOIN|CUMIPMT|CUMPRINC|CURRENCY|CURRENTGROUP|CUSTOMDATA|DATATABLE|DATE|DATEADD|DATEDIFF|DATESBETWEEN|DATESINPERIOD|DATESMTD|DATESQTD|DATESYTD|DATEVALUE|DAY|DB|DDB|DEGREES|DETAILROWS|DISC|DISTINCT|DISTINCTCOUNT|DISTINCTCOUNTNOBLANK|DIVIDE|DOLLARDE|DOLLARFR|DURATION|EARLIER|EARLIEST|EDATE|EFFECT|ENDOFMONTH|ENDOFQUARTER|ENDOFYEAR|EOMONTH|ERROR|EVALUATEANDLOG|EVEN|EXACT|EXCEPT|EXP|EXPAND|EXPANDALL|EXPON\.DIST|EXTERNALMEASURE|FACT|FALSE|FILTER|FILTERS|FIND|FIRST|FIRSTDATE|FIRSTNONBLANK|FIRSTNONBLANKVALUE|FIXED|FLOOR|FORMAT|FV|GCD|GENERATE|GENERATEALL|GENERATESERIES|GEOMEAN|GEOMEANX|GROUPBY|HASH|HASONEFILTER|HASONEVALUE|HOUR|IF|IF\.EAGER|IFERROR|IGNORE|INDEX|INFO\.ALTERNATEOFDEFINITIONS|INFO\.ANNOTATIONS|INFO\.ATTRIBUTEHIERARCHIES|INFO\.ATTRIBUTEHIERARCHYSTORAGES|INFO\.CALCULATIONGROUPS|INFO\.CALCULATIONITEMS|INFO\.CHANGEDPROPERTIES|INFO\.COLUMNPARTITIONSTORAGES|INFO\.COLUMNPERMISSIONS|INFO\.COLUMNS|INFO\.COLUMNSTORAGES|INFO\.CULTURES|INFO\.DATACOVERAGEDEFINITIONS|INFO\.DATASOURCES|INFO\.DELTATABLEMETADATASTORAGES|INFO\.DETAILROWSDEFINITIONS|INFO\.DICTIONARYSTORAGES|INFO\.EXCLUDEDARTIFACTS|INFO\.EXPRESSIONS|INFO\.EXTENDEDPROPERTIES|INFO\.FORMATSTRINGDEFINITIONS|INFO\.FUNCTIONS|INFO\.GENERALSEGMENTMAPSEGMENTMETADATASTORAGES|INFO\.GROUPBYCOLUMNS|INFO\.HIERARCHIES|INFO\.HIERARCHYSTORAGES|INFO\.KPIS|INFO\.LEVELS|INFO\.LINGUISTICMETADATA|INFO\.MEASURES|INFO\.MODEL|INFO\.OBJECTTRANSLATIONS|INFO\.PARQUETFILESTORAGES|INFO\.PARTITIONS|INFO\.PARTITIONSTORAGES|INFO\.PERSPECTIVECOLUMNS|INFO\.PERSPECTIVEHIERARCHIES|INFO\.PERSPECTIVEMEASURES|INFO\.PERSPECTIVES|INFO\.PERSPECTIVETABLES|INFO\.QUERYGROUPS|INFO\.REFRESHPOLICIES|INFO\.RELATEDCOLUMNDETAILS|INFO\.RELATIONSHIPINDEXSTORAGES|INFO\.RELATIONSHIPS|INFO\.RELATIONSHIPSTORAGES|INFO\.ROLEMEMBERSHIPS|INFO\.ROLES|INFO\.SEGMENTMAPSTORAGES|INFO\.SEGMENTSTORAGES|INFO\.STORAGEFILES|INFO\.STORAGEFOLDERS|INFO\.STORAGETABLECOLUMNS|INFO\.STORAGETABLECOLUMNSEGMENTS|INFO\.STORAGETABLES|INFO\.TABLEPERMISSIONS|INFO\.TABLES|INFO\.TABLESTORAGES|INFO\.VARIATIONS|INT|INTERSECT|INTRATE|IPMT|ISAFTER|ISATLEVEL|ISBLANK|ISCROSSFILTERED|ISEMPTY|ISERROR|ISEVEN|ISFILTERED|ISINSCOPE|ISLOGICAL|ISNONTEXT|ISNUMBER|ISO\.CEILING|ISODD|ISONORAFTER|ISPMT|ISSELECTEDMEASURE|ISSUBTOTAL|ISTEXT|KEEPFILTERS|KEYWORDMATCH|LAST|LASTDATE|LASTNONBLANK|LASTNONBLANKVALUE|LCM|LEFT|LEN|LINEST|LINESTX|LN|LOG|LOG10|LOOKUP|LOOKUPVALUE|LOWER|MATCHBY|MAX|MAXA|MAXX|MDURATION|MEDIAN|MEDIANX|MID|MIN|MINA|MINUTE|MINX|MOD|MONTH|MOVINGAVERAGE|MROUND|NAMEOF|NATURALINNERJOIN|NATURALLEFTOUTERJOIN|NETWORKDAYS|NEXT|NEXTDAY|NEXTMONTH|NEXTQUARTER|NEXTYEAR|NOMINAL|NONVISUAL|NORM\.DIST|NORM\.INV|NORM\.S\.DIST|NORM\.S\.INV|NOT|NOW|NPER|ODD|ODDFPRICE|ODDFYIELD|ODDLPRICE|ODDLYIELD|OFFSET|OPENINGBALANCEMONTH|OPENINGBALANCEQUARTER|OPENINGBALANCEYEAR|OR|ORDERBY|PARALLELPERIOD|PARTITIONBY|PATH|PATHCONTAINS|PATHITEM|PATHITEMREVERSE|PATHLENGTH|PDURATION|PERCENTILE\.EXC|PERCENTILE\.INC|PERCENTILEX\.EXC|PERCENTILEX\.INC|PERMUT|PI|PMT|POISSON\.DIST|POWER|PPMT|PREVIOUS|PREVIOUSDAY|PREVIOUSMONTH|PREVIOUSQUARTER|PREVIOUSYEAR|PRICE|PRICEDISC|PRICEMAT|PRODUCT|PRODUCTX|PV|QUARTER|QUOTIENT|RADIANS|RAND|RANDBETWEEN|RANGE|RANK|RANK\.EQ|RANKX|RATE|RECEIVED|RELATED|RELATEDTABLE|REMOVEFILTERS|REPLACE|REPT|RIGHT|ROLLUP|ROLLUPADDISSUBTOTAL|ROLLUPGROUP|ROLLUPISSUBTOTAL|ROUND|ROUNDDOWN|ROUNDUP|ROW|ROWNUMBER|RRI|RUNNINGSUM|SAMEPERIODLASTYEAR|SAMPLE|SAMPLEAXISWITHLOCALMINMAX|SAMPLECARTESIANPOINTSBYCOVER|SEARCH|SECOND|SELECTCOLUMNS|SELECTEDMEASURE|SELECTEDMEASUREFORMATSTRING|SELECTEDMEASURENAME|SELECTEDVALUE|SIGN|SIN|SINH|SLN|SQRT|SQRTPI|STARTOFMONTH|STARTOFQUARTER|STARTOFYEAR|STDEV\.P|STDEV\.S|STDEVX\.P|STDEVX\.S|SUBSTITUTE|SUBSTITUTEWITHINDEX|SUM|SUMMARIZE|SUMMARIZECOLUMNS|SUMX|SWITCH|SYD|T\.DIST|T\.DIST\.2T|T\.DIST\.RT|T\.INV|T\.INV\.2T|TAN|TANH|TBILLEQ|TBILLPRICE|TBILLYIELD|TIME|TIMEVALUE|TOCSV|TODAY|TOJSON|TOPN|TOPNPERLEVEL|TOPNSKIP|TOTALMTD|TOTALQTD|TOTALYTD|TREATAS|TRIM|TRUE|TRUNC|UNICHAR|UNICODE|UNION|UPPER|USERCULTURE|USERELATIONSHIP|USERNAME|USEROBJECTID|USERPRINCIPALNAME|UTCNOW|UTCTODAY|VALUE|VALUES|VAR\.P|VAR\.S|VARX\.P|VARX\.S|VDB|WEEKDAY|WEEKNUM|WINDOW|XIRR|XNPV|YEAR|YEARFRAC|YIELD|YIELDDISC|YIELDMAT)\b/i,
      end: /(?=\s*\()/,
      excludeEnd: true,
      relevance: 5
    };

    // https://learn.microsoft.com/en-us/dax/dax-operator-reference
    const OPERATOR = {
      className: 'operator',
      begin: /[-+*/^&]|==?|&&?|\|\||<(?:=>?|<|>)?|>[>=]?/,
      relevance: 0,
    };

    const PUNCTUATION = {
      className: 'punctuation',
      begin: /[;:()\[\]\{\},.]/,
      relevance: 0,
    };

    const NUMBER = {
      className: 'number',
      begin: /\b-?\d+(?:e\d+)?(?:\.\d+)?/,
      relevance: 0,
    };

    const STRING = {
      className: 'string',
      begin: /"(?:[^"]|"")*"(?!")/,
      relevance: 0,
    };

    const TABLECOLUMN = {
      className: 'variable',
      begin: /'(?:[^']|'')*'(?!')(?:\[.+\])?|\w+\[.+\]/,
      relevance: 0,
    };

    const MEASURE = {
      className: 'variable',
      begin: /\[.+\]/,
      relevance: 0,
    };
    
    // Special case for SWITCH function to prevent true/false coloring issues
    const SWITCH_FUNCTION = {
      className: 'built_in',
      begin: /\bSWITCH\b/i,
      end: /\(/,
      excludeEnd: true,
      relevance: 20
    };
    
    // Special rule for SWITCH(true, ...) pattern
    const SWITCH_TRUE = {
      begin: /\b(SWITCH)\s*\(\s*(true)\b/i,
      end: /\)/,
      excludeEnd: true,
      returnBegin: true,
      contains: [
        {
          // Match the SWITCH keyword
          className: 'built_in',
          begin: /SWITCH/i,
          end: /\s*\(/,
          excludeEnd: true
        },
        {
          // Match the TRUE keyword but don't color it specially
          begin: /\(\s*true\b/i,
          end: /,/,
          excludeEnd: true
        },
        {
          // For the content after 'true,'
          begin: /,/,
          end: /(?=\))/,
          contains: [
            STRING,
            NUMBER,
            {
              className: 'operator',
              begin: /&|<|>|=|,/
            },
            // We don't add specific rules for variables to avoid coloring
          ]
        }
      ],
      relevance: 30  // Highest priority
    };
    
    // Data type after colon
    const DATA_TYPE_AFTER_COLON = {
      className: 'type',
      begin: /:\s*(ANYVAL|SCALAR|VARIANT|INT64|DECIMAL|DOUBLE|STRING|DATETIME|BOOLEAN|NUMERIC|TABLE|ANYREF)\b/i,
      relevance: 10
    };
    
    // Type indicators (VAL, EXPR)
    const TYPE_INDICATOR = {
      className: 'keyword',
      begin: /\b(VAL|EXPR)\b/,
      relevance: 5
    };
    
    // Boolean literals - only highlighted when standalone (not in SWITCH conditions)
    const BOOLEAN_LITERAL = {
      className: 'literal',
      begin: /\b(TRUE|FALSE)\b(?!\s*,)/i,
      relevance: 5
    };

    return {
      name: 'DAX',
      case_insensitive: true,
      keywords: {
        keyword: KEYWORDS,
        type: TYPES,
      },
      contains: [
        hljs.COMMENT('//', '$'),
        hljs.C_BLOCK_COMMENT_MODE,
        SWITCH_TRUE, // This must come first to have highest priority
        SWITCH_FUNCTION, // Special handling for SWITCH function
        DATA_TYPE_AFTER_COLON, // Add this before other rules to prioritize it
        TYPE_INDICATOR, // For VAL and EXPR keywords
        BOOLEAN_LITERAL, // For TRUE/FALSE only when not in SWITCH conditions
        USER_DEFINED_FUNCTION,
        BUILTIN_FUNCTION,
        TABLECOLUMN,
        MEASURE,
        STRING,
        NUMBER,
        OPERATOR,
        PUNCTUATION,
      ],
    };
  }

  return dax;
})();

hljs.registerLanguage('dax', hljsGrammar);
})();